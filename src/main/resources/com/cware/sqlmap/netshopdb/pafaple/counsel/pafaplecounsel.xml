<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
        "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="pafaple.counsel">

	<select id="selectPaFapleCs" resultType="com.cware.netshopping.domain.PaqnamVO">
		SELECT /* pafaplecounsel.xml : pafaple.councel.counsel.selectPaFapleCs */
	           PQ.PA_COUNSEL_SEQ
	         , PQ.PROC_GB
	         , PQ.PA_CODE
	         , PQ.PA_COUNSEL_NO
	         , PQ.COUNSEL_SEQ
	         , PQ.COUNSEL_DATE
	         , PQ.COUNSEL_GB
	         , PQ.PA_GOODS_DT_CODE
	         , PQ.PA_ORDER_NO
	         , (SELECT PM.ORDER_NO 
	              FROM TPAORDERM PM 
	             WHERE PM.PA_CODE = PQ.PA_CODE
	               AND PM.PA_ORDER_NO = PQ.PA_ORDER_NO 
	               AND PM.PA_ORDER_GB ='10' 
	               AND ROWNUM = 1 ) AS REF_NO
	         , PQ.ORDER_YN
	         , PQ.DISPLAY_YN
	         , PQ.PA_CUST_NO
	         , PQ.CUST_NAME
	         , PQ.CUST_TEL
	         , PQ.RECEIPT_DATE
	         , PQ.TRANS_YN
	         , PQ.TRANS_DATE
	         , PQ.INSERT_DATE
	         , PQ.INSERT_ID
	         , PQ.MODIFY_DATE
	         , PQ.MODIFY_ID
	         , PD.PA_COUNSEL_DT_SEQ
	         , PD.TITLE
	         , PD.PROC_NOTE
	         , PG.GOODS_CODE AS GOODS_CODE
	         , PGM.ITEM_ID AS PA_GOODS_CODE
	         , PG.ENTP_CODE
	         , NVL((SELECT OM.CUST_NO
	                 FROM TPAORDERM PM, TORDERM OM
	                WHERE PQ.PA_ORDER_NO = PM.PA_ORDER_NO
	                  AND PM.ORDER_NO = OM.ORDER_NO
	                  AND PM.PA_CODE = PQ.PA_CODE
	                  AND ROWNUM = 1
	               ) ,(SELECT TO_CHAR(CODE_NAME)
	                  FROM TCODE TC
	                 WHERE TC.CODE_LGROUP = 'O511'
	                   AND TC.REMARK1 = '14'
	                   AND ROWNUM = 1
	                 ) ) AS CUST_NO
	          , CK.CS_SGROUP
	          , CK.CS_LMS_CODE
	      FROM TPAQNAM PQ
	         , TPAQNADT PD
	         , TPAPRODUCT PG
	         , TPAFAPLEGOODS PGM
	         , TCSKINDS CK
	     WHERE PQ.PA_COUNSEL_SEQ = PD.PA_COUNSEL_SEQ
	       AND PQ.PROC_GB = PD.PROC_GB
	       AND PQ.PA_CODE IN ('E1','E2')
	       AND PQ.PA_GOODS_CODE = PGM.ITEM_ID(+)
	       AND PQ.PA_CODE = PGM.PA_CODE(+)
	       AND PGM.GOODS_CODE = PG.GOODS_CODE(+)
	       AND PQ.COUNSEL_SEQ IS NULL
	       AND PQ.PROC_GB = '10'
	       AND PQ.TRANS_YN = '0'
	       AND PQ.TRANS_DATE IS NULL 
	       AND PQ.MSG_GB = '10'
	       AND PQ.INSERT_DATE > TRUNC(SYSDATE) - 3
	       AND PD.PA_COUNSEL_DT_SEQ = '1'
	       AND CK.CS_LGROUP = '60'
	       AND CK.CS_MGROUP = '14'
	       AND CK.CS_SGROUP = '06'
    </select>

	<select id="selectPaGoodsCode" parameterType="String" resultType="String">
    	SELECT PGM.ITEM_ID /* pafaplecounsel.xml : pafaple.counsel.selectPaGoodsCode */
 		  FROM TPAFAPLEGOODS PGM
 		 WHERE PGM.GOODS_CODE = #{goodsCode, jdbcType=VARCHAR}
	</select>


    <select id="selectCsNoticeAnsList" parameterType="hashMap" resultType="com.cware.netshopping.domain.PaqnamVO">
    	SELECT /* pafaplecounsel.xml : pafaple.counsel.selectCsNoticeAnsList */
	          SQ.PA_COUNSEL_NO
	        , SQ.PA_COUNSEL_SEQ
	        , SQ.PA_GOODS_CODE
	        , SQ.PA_GOODS_DT_CODE
	        , CD.PROC_NOTE
	        , SQ.PA_CODE
	        , CD.PROC_ID
	     FROM TPAQNAM SQ
	        , TCUSTCOUNSELM CM
	        , TCUSTCOUNSELDT CD
	    WHERE SQ.COUNSEL_SEQ = CM.COUNSEL_SEQ
	      AND CM.COUNSEL_SEQ = CD.COUNSEL_SEQ
	      AND CD.DO_FLAG     = '40'
	      AND CD.PROC_DATE   > SYSDATE - 3
	      AND SQ.TRANS_YN    = '0'
	      AND SQ.MSG_GB    = '10'
	      AND SQ.PA_GROUP_CODE = '14'
        <if test='paCounselNo != null and paCounselNo != ""'>
           AND SQ.PA_COUNSEL_NO = #{paCounselNo, jdbcType=VARCHAR}
        </if>
       
    </select>

    <update id="updatePaQnaTrans" parameterType="com.cware.netshopping.domain.PaqnamVO">
    	UPDATE TPAQNAM /* pafaplecounsel.xml : pafaple.counsel.updatePaQnaTrans */
           SET TRANS_YN = '1'
             , PROC_GB = '40'
             , TRANS_DATE = #{modifyDate, jdbcType=TIMESTAMP}
             , MODIFY_ID = #{modifyId, jdbcType=VARCHAR}
             , MODIFY_DATE = #{modifyDate, jdbcType=TIMESTAMP}
         WHERE PA_COUNSEL_SEQ  = #{paCounselSeq, jdbcType=VARCHAR}
    </update>
    
    <select id="selectPaQnaDtMaxSeq" parameterType="com.cware.netshopping.domain.PaqnamVO" resultType="String">
    	SELECT /* pafaplecounsel.xml : pafaple.counsel.selectPaQnaDtMaxSeq */
    		   MAX(P.PA_COUNSEL_DT_SEQ) + 1 
    	  FROM TPAQNADT P 
    	 WHERE P.PA_COUNSEL_SEQ = #{paCounselSeq, jdbcType=VARCHAR}
	</select>
	
	<insert id="insertPaQnaDt" parameterType="com.cware.netshopping.domain.PaqnamVO">
    	INSERT INTO TPAQNADT( /* pafaplecounsel.xml : pafaple.counsel.insertPaQnaDt */
			PA_COUNSEL_SEQ
		  , PA_COUNSEL_DT_SEQ
		  , PROC_GB
		  , TITLE
		  , PROC_NOTE
		  , PROC_DATE
		  , PROC_ID) 
		VALUES (
		    #{paCounselSeq, jdbcType=VARCHAR}
		  , #{paCounselDtSeq, jdbcType=VARCHAR}
		  , #{procGb, jdbcType=VARCHAR}
		  , #{title, jdbcType=VARCHAR}
		  , #{procNote, jdbcType=VARCHAR}
		  , SYSDATE
		  , #{procId, jdbcType=VARCHAR})
	</insert>

	<select id="selectPaFapleQna" resultType="com.cware.netshopping.domain.PaqnamVO">
    	SELECT /* pafaplecounsel.xml : pafaple.counsel.selectPaFapleQna */
		       PQ.PA_COUNSEL_SEQ
		     , PQ.PROC_GB
		     , PQ.PA_CODE
		     , PQ.PA_COUNSEL_NO
		     , PQ.COUNSEL_SEQ
		     , PQ.COUNSEL_DATE
		     , PQ.COUNSEL_GB
		     , PQ.PA_GOODS_DT_CODE
		     , PQ.PA_ORDER_NO
		     , (SELECT PM.ORDER_NO 
		          FROM TPAORDERM PM 
		         WHERE PM.PA_CODE = PQ.PA_CODE
		           AND PM.PA_ORDER_NO = PQ.PA_ORDER_NO 
		           AND PM.PA_ORDER_GB ='10' 
		           AND ROWNUM = 1 ) AS REF_NO
		     , PQ.ORDER_YN
		     , PQ.DISPLAY_YN
		     , PQ.PA_CUST_NO
		     , PQ.CUST_NAME
		     , PQ.CUST_TEL
		     , PQ.RECEIPT_DATE
		     , PQ.TRANS_YN
		     , PQ.TRANS_DATE
		     , PQ.INSERT_DATE
		     , PQ.INSERT_ID
		     , PQ.MODIFY_DATE
		     , PQ.MODIFY_ID
		     , PD.PA_COUNSEL_DT_SEQ
		     , PD.TITLE
		     , PD.PROC_NOTE
		     , PG.GOODS_CODE AS GOODS_CODE
		     , PG.GOODS_CODE AS PA_GOODS_CODE
		     , PG.ENTP_CODE
		     , NVL((SELECT OM.CUST_NO
		             FROM TPAORDERM PM, TORDERM OM
		            WHERE PQ.PA_ORDER_NO = PM.PA_ORDER_NO
		              AND PM.ORDER_NO = OM.ORDER_NO
		              AND ROWNUM = 1
		           ) ,(SELECT TO_CHAR(CODE_NAME)
		              FROM TCODE TC
		             WHERE TC.CODE_LGROUP = 'O511'
		               AND TC.REMARK1 = '14'
		               AND ROWNUM = 1
		             ) ) AS CUST_NO
		  FROM TPAQNAM PQ
		     , TPAQNADT PD
		     , TPAPRODUCT PG
		     , TPAFAPLEGOODS PGM
		 WHERE PQ.PA_COUNSEL_SEQ = PD.PA_COUNSEL_SEQ
		   AND PQ.PROC_GB = PD.PROC_GB
		   AND PQ.PA_CODE IN ('E1','E2')
		   AND PQ.PA_GOODS_CODE = PGM.ITEM_ID
		   AND PQ.PA_CODE = PGM.PA_CODE
		   AND PG.GOODS_CODE = PGM.GOODS_CODE
		   AND PQ.COUNSEL_SEQ IS NULL
		   AND PQ.PROC_GB = '10'
		   AND PQ.TRANS_YN = '0'
		   AND PQ.TRANS_DATE IS NULL 
		   AND PQ.MSG_GB = '00'
		   AND PQ.INSERT_DATE > TRUNC(SYSDATE) - 3
		   AND PD.PA_COUNSEL_DT_SEQ = '1'
    </select>
    
    <select id="selectPaFapleAnsQna" parameterType="String" resultType="com.cware.netshopping.domain.PaqnamVO">
    	SELECT /* pafaplecounsel.xml : pafaple.counsel.selectPaFapleAnsQna */
	          SQ.PA_COUNSEL_NO
	        , SQ.PA_COUNSEL_SEQ
	        , SQ.PA_GOODS_CODE
	        , SQ.PA_GOODS_DT_CODE
	        , CD.PROC_NOTE
	        , SQ.PA_CODE
	        , CD.PROC_ID
	     FROM TPAQNAM SQ
	        , TCUSTCOUNSELM CM
	        , TCUSTCOUNSELDT CD
	    WHERE SQ.COUNSEL_SEQ = CM.COUNSEL_SEQ
	      AND CM.COUNSEL_SEQ = CD.COUNSEL_SEQ
	      AND CD.DO_FLAG     = '40'
	      AND CD.PROC_DATE   > SYSDATE - 3
	      AND SQ.TRANS_YN    = '0'
	      AND SQ.MSG_GB    = '00'
	      AND SQ.PA_GROUP_CODE = '14'
        <if test='paCounselNo != null and paCounselNo != ""'>
           AND SQ.PA_COUNSEL_NO = #{paCounselNo, jdbcType=VARCHAR}
        </if>
       
    </select>
    
    <select id="selectCountPaFapleQna" resultType="int" parameterType="com.cware.netshopping.pafaple.domain.PaFapleQnaVO">
    	SELECT /* pafaplecounsel.xml : pafaple.counsel.selectCountPaFapleQna */
	        COUNT(*)
	     FROM TPAFAPLEQNA Q
        WHERE Q.BBS_ID = #{bbsId, jdbcType=VARCHAR}
          AND Q.NUMM = #{numm, jdbcType=VARCHAR}
    </select>
    
    <select id="selectPaFapleQnaDt" resultType="com.cware.netshopping.pafaple.domain.PaFapleQnaVO" parameterType="com.cware.netshopping.domain.PaqnamVO">
    	SELECT /* pafaplecounsel.xml : pafaple.counsel.selectPaFapleQnaDt */
	        Q.BBS_KIND,
			Q.BBS_ID,
			Q.NUMM,
			Q.REF,
			Q.STEP,
			Q.RELEVEL
	     FROM TPAFAPLEQNA Q
        WHERE Q.NUMM = #{paCounselNo, jdbcType=VARCHAR}
    </select>
    
    <insert id="insertPaFapleQna" parameterType="com.cware.netshopping.pafaple.domain.PaFapleQnaVO">
    	INSERT INTO TPAFAPLEQNA( /* pafaplecounsel.xml : pafaple.counsel.insertPaFapleQna */
		BBS_KIND,
		BBS_ID,
		NUMM,
		REF,
		STEP,	
		RELEVEL) 
		VALUES (
		    #{bbsKind,  jdbcType=VARCHAR}
		  , #{bbsId,   jdbcType=VARCHAR}
		  , #{numm,     jdbcType=VARCHAR}
		  , #{ref,    jdbcType=VARCHAR}
		  , #{step,     jdbcType=VARCHAR}
		  , #{relevel,   jdbcType=VARCHAR} 
		  )
	</insert>
</mapper>