<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
        "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="patmon.counsel">

	<select id="selectPaTmonQna" resultType="com.cware.netshopping.domain.PaqnamVO" parameterType="String">
    	SELECT /* patmoncounsel.xml : patmon.patmoncounsel.selectPaTmonQna */
               PQ.PA_COUNSEL_SEQ
             , PQ.PROC_GB
             , PQ.PA_CODE
             , PQ.PA_COUNSEL_NO
             , PQ.COUNSEL_SEQ
             , PQ.COUNSEL_DATE
             , PQ.COUNSEL_GB
             , PQ.PA_GOODS_CODE
             , (SELECT A.ORDER_NO
             	  FROM TPAORDERM A
             	 WHERE A.PA_CODE = PQ.PA_CODE
             	   AND A.PA_ORDER_NO = PQ.PA_ORDER_NO
             	   AND rownum = 1
             ) AS REF_NO
             , PQ.DISPLAY_YN
             , PQ.CUST_NAME
             , PQ.CUST_TEL
             , PQ.TRANS_YN
             , PQ.TRANS_DATE
             , PQ.INSERT_DATE
             , PQ.INSERT_ID
             , PQ.MODIFY_DATE
             , PQ.MODIFY_ID
             , PD.PA_COUNSEL_DT_SEQ
             , PQ.MSG_GB
             , PD.PROC_NOTE
             , PG.GOODS_CODE
             , PG.ENTP_CODE
             , (SELECT TO_CHAR(CODE_NAME)
                  FROM TCODE TC
                 WHERE TC.CODE_LGROUP = 'O511'
                   AND TC.REMARK1     = '09'
                   AND ROWNUM         = 1) AS CUST_NO
             , PQ.TOKEN
             , CK.CS_SGROUP
             , CK.CS_LMS_CODE
             , CK.CS_SGROUP_NAME AS TITLE
          FROM TPAQNAM PQ
             , TPAQNADT PD
             , TPAPRODUCT PG
             , TPATMONGOODS TG
             , TCSKINDS CK
         WHERE PQ.PA_COUNSEL_SEQ	= PD.PA_COUNSEL_SEQ
           AND PQ.PROC_GB			= PD.PROC_GB
           AND PQ.PA_GOODS_CODE		= TG.DEAL_NO
           AND TG.GOODS_CODE		= PG.GOODS_CODE
           AND PQ.COUNSEL_SEQ		IS NULL
           AND PQ.PROC_GB			= '10'
           AND PQ.TRANS_YN			= '0'
           AND PQ.TRANS_DATE		IS NULL
           AND PD.PA_COUNSEL_DT_SEQ	= '1'
           AND PQ.PA_CODE			IN ('91', '92')
           AND PQ.INSERT_DATE		> TRUNC(SYSDATE) - 3
           AND PQ.MSG_GB			= #{msgGb, jdbcType=VARCHAR}
           AND CK.CS_LGROUP = '60'
           AND CK.CS_MGROUP = '09'
           AND CK.CS_SGROUP = DECODE(PQ.MSG_GB,'00','01',DECODE(PQ.TOKEN,'4','02','6','03','7','04','5','05','3','06','2','07','1','08','8','11','09'))
    </select>
   	
   	<select id="selectPaTmonAnsQna" parameterType="hashMap" resultType="com.cware.netshopping.domain.PaqnamVO">
		SELECT /* patmoncounsel.xml : patmon.patmoncounsel.selectPaTmonAnsQna */
			   SQ.PA_COUNSEL_NO
			 , SQ.PA_COUNSEL_SEQ
			 , SQ.PA_GOODS_CODE
			 , SQ.PA_GOODS_DT_CODE
			 , CD.PROC_NOTE
			 , SQ.PA_CODE
			 , SQ.TOKEN
		  FROM TPAQNAM SQ
			 , TCUSTCOUNSELM CM
			 , TCUSTCOUNSELDT CD
		 WHERE SQ.COUNSEL_SEQ = CM.COUNSEL_SEQ
		   AND CM.COUNSEL_SEQ = CD.COUNSEL_SEQ
		   AND CD.DO_FLAG     = '40'
		   AND CD.PROC_DATE   > SYSDATE - 3
		   AND SQ.TRANS_YN    = '0'
		   AND SQ.MSG_GB	  = #{msgGb, jdbcType=VARCHAR}
		   AND SQ.PA_GROUP_CODE = '09'
	    <if test='paCounselNo != null and paCounselNo != ""'>
           AND SQ.PA_COUNSEL_NO = #{paCounselNo, jdbcType=VARCHAR}
        </if>
    </select>
    
    <update id="updatePaQnaTrans" parameterType="com.cware.netshopping.domain.PaqnamVO">
    	UPDATE TPAQNAM /* patmoncounsel.xml : patmon.patmoncounsel.updatePaQnaTrans */
           SET TRANS_YN = '1'
             , PROC_GB = '40'
             , TRANS_DATE = #{modifyDate, jdbcType=TIMESTAMP}
             , MODIFY_ID = #{modifyId, jdbcType=VARCHAR}
             , MODIFY_DATE = #{modifyDate, jdbcType=TIMESTAMP}
         WHERE PA_COUNSEL_SEQ  = #{paCounselSeq, jdbcType=VARCHAR}
    </update>
    
    <select id="selectPaQnaDtMaxSeq" parameterType="com.cware.netshopping.domain.PaqnamVO" resultType="String">
    	SELECT /* patmoncounsel.xml : patmon.patmonpcounsel.selectPaQnaDtMaxSeq */
    		   MAX(P.PA_COUNSEL_DT_SEQ) + 1 
    	  FROM TPAQNADT P 
    	 WHERE P.PA_COUNSEL_SEQ = #{paCounselSeq, jdbcType=VARCHAR}
	</select>
    
	<insert id="insertPaQnaDt" parameterType="com.cware.netshopping.domain.PaqnamVO">
    	INSERT INTO TPAQNADT( /* patmoncounsel.xml : patmon.patmoncounsel.insertPaQnaDt */
			PA_COUNSEL_SEQ
		  , PA_COUNSEL_DT_SEQ
		  , PROC_GB
		  , TITLE
		  , PROC_NOTE
		  , PROC_DATE
		  , PROC_ID) 
		VALUES (
		    #{paCounselSeq, jdbcType=VARCHAR}
		  , #{paCounselDtSeq, jdbcType=VARCHAR}
		  , #{procGb, jdbcType=VARCHAR}
		  , #{title, jdbcType=VARCHAR}
		  , #{procNote, jdbcType=VARCHAR}
		  , #{procDate, jdbcType=TIMESTAMP}
		  , #{procId, jdbcType=VARCHAR})
	</insert>
	
	<select id="selectPaCounselNoCheck" parameterType="String" resultType="int">
    	SELECT /* patmoncounsel.xml : patmon.patmonpcounsel.selectPaCounselNoCheck */
              COUNT(1)
         FROM TPAQNAM 
        WHERE PA_COUNSEL_NO = #{paCounselNo, jdbcType=VARCHAR}
		  AND PROC_GB = '10'
          AND COUNSEL_GB = '07'
	</select>
</mapper>