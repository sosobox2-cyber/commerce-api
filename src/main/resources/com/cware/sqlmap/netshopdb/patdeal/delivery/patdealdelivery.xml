<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
        "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="patdeal.delivery">

	<select id="selectCountOrderList" parameterType="hashMap" resultType="int">
		SELECT /* patdealdelivery.xml: patdeal.delivery.selectCountOrderList by PaTdealDeliveryController*/
	    	   COUNT(1) AS CNT
	  	  FROM TPATDEALORDERLIST OL
	 	 WHERE OL.ORDER_NO		        = #{orderNo  	        ,  jdbcType=VARCHAR}
           AND OL.OPTION_MANAGEMENT_CD	= #{optionManagementCd  ,  jdbcType=VARCHAR}
           AND OL.PA_ORDER_GB	        = '10'
	</select>
	
	
	
	<insert id="insertPaTdealOrderList" parameterType="hashMap">
        INSERT /* patdealdelivery.xml: patdeal.delivery.insertPaTdealOrderList by PaTdealDeliveryController*/
          INTO TPATDEALORDERLIST ( 
          	   PA_ORDER_GB							, ORDER_NO						, OPTION_MANAGEMENT_CD				
          	 , ORDER_PRODUCT_OPTION_NO				, ORDER_PRODUCT_NO				, ORDER_YMDT			
          	 , PRODUCT_MANAGEMENT_CD				, MALL_PRODUCT_NO				, MALL_OPTION_NO
	         , PRODUCT_NAME							, OPTION_NAME					, OPTION_VALUE			
	         , RELEASE_WAREHOUSE_NO					, DELIVERY_NO					, ORIGINAL_DELIVERY_NO			
	         , DELIVERY_TEMPLATE_NO					, DELIVERY_CONDITION_NO			, DELIVERY_TEMPLATE_GROUP_NO		
	         , DELIVERY_AMT							, REMOTE_DELIVERY_AMT			, RECEIVER_NAME
	         , RECEIVER_CONTACT1					, RECEIVER_CONTACT2				, RECEIVER_ZIP_CD				
	         , RECEIVER_JIBUN_ADDRESS				, RECEIVER_ADDRESS				, RECEIVER_DETAIL_ADDRESS				
	         , DELIVERY_MEMO						, COMBINE_DELIVERY_YN			, ORDERER_NAME				
	         , ORDER_MEMO			    			, ORDERER_EMAIL					, ORDERER_CONTACT1
	         , ORDERER_CONTACT2						, MEMBER_NO						, MEMBER_ID				
	         , SALE_PRICE			     			, ADJUSTED_AMT					, ORIGINAL_ORDER_CNT 		
	         , ORDER_CNT				 			, IMMEDIATE_DISCOUNT_AMT		, ADDITIONAL_DISCOUNT_AMT			
	         , LAST_PRODUCT_COUPON_DISCOUNT_AMT		, PURCHASE_PRICE				, PAY_TYPE
	         , PLATFORM_TYPE						, PG_TYPE						, PAY_TYPE_LABEL				
	         , CURRENCY_CODE					    , INSERT_DATE					, MODIFY_DATE			

        	) 
        VALUES(
              #{paOrderGb	 						, jdbcType=VARCHAR} 	, #{orderNo						, jdbcType=VARCHAR} 	, #{optionManagementCd			, jdbcType=VARCHAR} 	
			, #{orderProductOptionNo		 		, jdbcType=VARCHAR} 	, #{orderProductNo				, jdbcType=VARCHAR} 	, #{orderYmdt					, jdbcType=TIMESTAMP} 	
			, #{productManagementCd	 				, jdbcType=VARCHAR} 	, #{mallProductNo				, jdbcType=VARCHAR} 	, #{mallOptionNo				, jdbcType=VARCHAR} 
			, #{productName		 					, jdbcType=VARCHAR} 	, #{optionName					, jdbcType=VARCHAR} 	, #{optionValue					, jdbcType=VARCHAR} 
			, #{releaseWarehouseNo 					, jdbcType=VARCHAR} 	, #{deliveryNo					, jdbcType=VARCHAR} 	, #{originalDeliveryNo			, jdbcType=VARCHAR} 
			, #{deliveryTemplateNo	 				, jdbcType=VARCHAR} 	, #{deliveryConditionNo			, jdbcType=VARCHAR} 	, #{deliveryTemplateGroupNo		, jdbcType=VARCHAR} 
			, #{deliveryAmt			 				, jdbcType=NUMERIC} 	, #{remoteDeliveryAmt			, jdbcType=NUMERIC} 	, #{receiverName				, jdbcType=VARCHAR} 
			, #{receiverContact1 					, jdbcType=VARCHAR} 	, #{receiverContact2			, jdbcType=VARCHAR} 	, #{receiverZipCd				, jdbcType=VARCHAR}
			, #{receiverJibunAddress 				, jdbcType=VARCHAR} 	, #{receiverAddress				, jdbcType=VARCHAR} 	, #{receiverDetailAddress		, jdbcType=VARCHAR}			
			, #{deliveryMemo 		 				, jdbcType=VARCHAR} 	, #{combineDeliveryYn			, jdbcType=VARCHAR} 	, #{ordererName					, jdbcType=VARCHAR}				
			, #{orderMemo 							, jdbcType=VARCHAR} 	, #{ordererEmail				, jdbcType=VARCHAR} 	, #{ordererContact1				, jdbcType=VARCHAR}		
			, #{ordererContact2 	 	 			, jdbcType=VARCHAR} 	, #{memberNo					, jdbcType=VARCHAR} 	, #{memberId					, jdbcType=VARCHAR}					
			, #{salePrice 	 	 					, jdbcType=NUMERIC} 	, #{adjustedAmt					, jdbcType=NUMERIC} 	, #{originalOrderCnt			, jdbcType=NUMERIC}					
			, #{orderCnt 	 	 					, jdbcType=NUMERIC} 	, #{immediateDiscountAmt		, jdbcType=NUMERIC} 	, #{additionalDiscountAmt		, jdbcType=NUMERIC}					
			, #{lastProductCouponDiscountAmt	 	, jdbcType=NUMERIC} 	, #{purchasePrice				, jdbcType=NUMERIC} 	, #{payType						, jdbcType=NUMERIC}						
			, #{platformType						, jdbcType=VARCHAR} 	, #{pgType						, jdbcType=VARCHAR} 	, #{payTypeLabel				, jdbcType=VARCHAR}		
			, #{currencyCode						, jdbcType=VARCHAR} 	, #{insertDate					, jdbcType=TIMESTAMP} 	, #{modifyDate					, jdbcType=TIMESTAMP}		
			
        )  
     </insert>
     
	<select id="selectOrderConfirmList" parameterType="hashMap" resultType="hashMap">
	    SELECT /* patdealdelivery.xml: patdeal.delivery.selectOrderConfirmList by PaTdealDeliveryController*/
	    	   OL.ORDER_NO
	    	 , OL.ORDER_PRODUCT_OPTION_NO
	    	 , OL.ORDER_CNT
	    	 , OL.PRODUCT_MANAGEMENT_CD
	    	 , OL.OPTION_MANAGEMENT_CD
	    	 , PM.MAPPING_SEQ
	    	 , PM.PA_CODE
	    	 , REPLACE(OL.RECEIVER_ZIP_CD,'-' , '' )  AS POST_NO
			 , CASE WHEN LENGTH( REPLACE(OL.RECEIVER_ZIP_CD,'-' , '' ) ) = 6  THEN  '01'  ELSE  '02'  END  AS  ADDR_GBN 
			 , NVL(OL.RECEIVER_ADDRESS, OL.RECEIVER_JIBUN_ADDRESS) || ' ' || OL.RECEIVER_DETAIL_ADDRESS AS STD_ADDR    
			 , NVL(OL.RECEIVER_ADDRESS, OL.RECEIVER_JIBUN_ADDRESS) || ' ' || OL.RECEIVER_DETAIL_ADDRESS AS RECEIVER_ADDR   
			 , PM.PA_ORDER_GB
		  FROM TPAORDERM PM , TPATDEALORDERLIST OL 
		 WHERE PM.PA_ORDER_NO   = OL.ORDER_NO
		   AND PM.PA_ORDER_SEQ  = OL.OPTION_MANAGEMENT_CD
		   AND PM.PA_ORDER_GB   = OL.PA_ORDER_GB
		   AND PM.PA_CODE       = #{paCode ,  jdbcType=VARCHAR}
		   <if test='orderProductOptionNo != "" and orderProductOptionNo != null '>
               AND OL.ORDER_PRODUCT_OPTION_NO = #{orderProductOptionNo , jdbcType=VARCHAR}
           </if>
		   AND PM.PA_DO_FLAG    = '10'
		   AND PM.PA_ORDER_GB   = '10'
		   AND PM.CREATE_YN     = '0' 
		   AND PM.PRE_CANCEL_YN = '0' 
		   
		 UNION ALL
		   
	    SELECT /*교환발송건*/
               PM.PA_ORDER_NO  AS ORDER_NO
             , PM.PA_SHIP_NO   AS ORDER_PRODUCT_OPTION_NO
             , OL.ORDER_CNT
             , SUBSTR(OL.OPTION_MANAGEMENT_CD, 1, LENGTH(OL.OPTION_MANAGEMENT_CD) - 3) AS PRODUCT_MANAGEMENT_CD
             , OL.OPTION_MANAGEMENT_CD
             , PM.MAPPING_SEQ
             , PM.PA_CODE
             , REPLACE(OL.RECEIVER_ZIP_CD,'-' , '' )  AS POST_NO
             , CASE WHEN LENGTH( REPLACE(OL.RECEIVER_ZIP_CD,'-' , '' ) ) = 6  THEN  '01'  ELSE  '02'  END  AS  ADDR_GBN 
             , NVL(OL.RECEIVER_ADDRESS, OL.RECEIVER_JIBUN_ADDRESS) || ' ' || OL.RECEIVER_DETAIL_ADDRESS AS STD_ADDR    
             , NVL(OL.RECEIVER_ADDRESS, OL.RECEIVER_JIBUN_ADDRESS) || ' ' || OL.RECEIVER_DETAIL_ADDRESS AS RECEIVER_ADDR   
             , PM.PA_ORDER_GB
          FROM TPAORDERM PM , TPATDEALCLAIMLIST OL 
		 WHERE PM.PA_ORDER_NO   = OL.ORDER_NO
		   AND PM.PA_ORDER_SEQ  = OL.OPTION_MANAGEMENT_CD
		   AND PM.PA_ORDER_GB   = OL.PA_ORDER_GB
		   AND PM.PA_CODE       = #{paCode ,  jdbcType=VARCHAR}
		   <if test='orderProductOptionNo != "" and orderProductOptionNo != null '>
               AND OL.OPTION_MANAGEMENT_CD = #{orderProductOptionNo , jdbcType=VARCHAR}
           </if>
		   AND PM.PA_DO_FLAG    = '25'
		   AND PM.PA_ORDER_GB   = '40'
		   AND PM.CREATE_YN     = '1' 
		   AND PM.PRE_CANCEL_YN = '0'  
	</select>
	
	<update id="updatePaorderm" parameterType="hashMap">
        UPDATE /* patdealdelivery.xml: patdeal.delivery.updatePaorderm by PaTdealDeliveryController*/
        	   TPAORDERM
           SET MODIFY_DATE		  = SYSDATE
             <if test='paDoFlag != null and paDoFlag != ""'>
             , PA_DO_FLAG 		  = #{paDoFlag			,	jdbcType=VARCHAR}
             </if>
             <if test='preCancelYn != null and preCancelYn != ""'>
             , PRE_CANCEL_YN 	  = #{preCancelYn		,	jdbcType=VARCHAR}
             </if>
             <if test='changeFlag != null and changeFlag != ""'>
             , CHANGE_FLAG 		  = #{changeFlag		, 	jdbcType=VARCHAR}
             </if>
             , API_RESULT_MESSAGE = #{resultMessage		,	jdbcType=VARCHAR}
             , API_RESULT_CODE	  = #{resultCode		,	jdbcType=VARCHAR}
         WHERE MAPPING_SEQ        = #{mappingSeq		,   jdbcType=VARCHAR}
    </update>

	<select id="selectOrderInputTargetList" parameterType="int" resultType="hashMap">
        SELECT  /* patdealdelivery.xml: patdeal.delivery.selectOrderInputTargetList by PaTdealDeliveryController*/
               AA.PA_ORDER_NO
             , AA.TARGET_CNT
          FROM (SELECT POM.PA_ORDER_NO
                     , COUNT(1) TARGET_CNT
                  FROM TPAORDERM POM
                 WHERE POM.PA_CODE        IN ('D1','D2')
                   AND POM.PA_ORDER_GB    = '10'
                   AND POM.CREATE_YN      = '0'
                   AND POM.PRE_CANCEL_YN  = '0'
                   AND POM.INSERT_DATE    > TRUNC(SYSDATE)-5
                   AND POM.PA_DO_FLAG	  = '30'
                 GROUP BY POM.PA_ORDER_NO
                 ORDER BY POM.PA_ORDER_NO) AA
          WHERE ROWNUM &lt;= #{limitCount, jdbcType=NUMERIC}
	</select>   
	
	<select id="selectOrderInputTargetDtList" parameterType="hashMap" resultType="hashMap">	 
		SELECT  /* patdealdelivery.xml: patdeal.delivery.selectOrderInputTargetDtList by PaTdealDeliveryController*/
			   PM.PA_ORDER_NO
		     , PM.PA_CODE
			 , PGM.MALL_PRODUCT_NO AS PA_GOODS_CODE
			 , PM.MAPPING_SEQ
			 , TC.REMARK1 AS MEDIA_CODE  
			 , TO_CHAR(OL.ORDER_YMDT, 'YYYYMMDDHH24MISS') AS ORDER_DATE
			 , PGD.GOODS_CODE
			 , PGD.GOODSDT_CODE
			 , OL.ORDER_CNT AS ORDER_QTY
			 , TO_CHAR(PP.APPLY_DATE, 'YYYYMMDDHH24MISS') APPLY_DATE
			 , PP.SUPPLY_PRICE
			 , NVL(OL.ORDERER_NAME	, OL.RECEIVER_NAME)		 AS CUST_NAME 
			 , NVL(OL.ORDERER_CONTACT1	  , OL.RECEIVER_CONTACT1)	 AS CUST_TEL1
			 , NVL(OL.ORDERER_CONTACT2	  , OL.RECEIVER_CONTACT2)	 AS CUST_TEL2
		 	 , NVL(OL.RECEIVER_NAME	, OL.ORDERER_NAME)		 AS RECEIVER_NAME 
		 	 , NVL(OL.RECEIVER_CONTACT1	  , OL.ORDERER_CONTACT1)	 AS RECEIVER_TEL
		 	 , NVL(OL.RECEIVER_CONTACT2	  , OL.ORDERER_CONTACT2)	 AS RECEIVER_HP
		 	 , REPLACE(OL.RECEIVER_ZIP_CD,'-' , '' )  AS POST_NO
		 	 , '001'						   AS POST_NO_SEQ 
		 	 , CASE WHEN LENGTH( REPLACE(OL.RECEIVER_ZIP_CD,'-' , '' ) ) = 6  THEN  '01'  ELSE  '02'  END  AS  ADDR_GBN 
		 	 , NVL(OL.RECEIVER_ADDRESS, OL.RECEIVER_JIBUN_ADDRESS) || ' ' || OL.RECEIVER_DETAIL_ADDRESS AS RECEIVER_ADDR      
		 	 , NVL(OL.RECEIVER_ADDRESS, OL.RECEIVER_JIBUN_ADDRESS) AS RCVR_BASE_ADDR
			 , OL.RECEIVER_DETAIL_ADDRESS AS RCVR_DTLS_ADDR
			 , NVL((OL.ADJUSTED_AMT),0) -NVL((OL.LAST_PRODUCT_COUPON_DISCOUNT_AMT),0) AS RSALE_AMT
		 	 , NVL((PP.SALE_PRICE * OL.ORDER_CNT),0) - ( NVL((OL.ADJUSTED_AMT),0) - NVL((OL.LAST_PRODUCT_COUPON_DISCOUNT_AMT),0) )  AS SELLER_DC_AMT
		 	 , NVL((PP.LUMP_SUM_DC_AMT * OL.ORDER_CNT),0) AS LUMP_SUM_DC_AMT
		 	 , NVL((PP.LUMP_SUM_ENTP_DC_AMT),0) AS LUMP_SUM_ENTP_DC_AMT
		 	 , NVL((PP.LUMP_SUM_OWN_DC_AMT),0) AS LUMP_SUM_OWN_DC_AMT
		 	 , OL.DELIVERY_MEMO  AS MSG
		 	 , NVL(OL.DELIVERY_AMT,0) + NVL(OL.REMOTE_DELIVERY_AMT,0) AS SHP_FEE_COST
		 	 , PP.PRICE_SEQ
		 	 , PP.SALE_PRICE  
		 	 , '99' AS CUST_CHAR
		 	 , '70' AS RECEIVE_METHOD
		 	 , 0 AS INSTANT_COUPON_DISCOUNT
		 	 , PP.COUPON_PROMO_NO AS PROMO_NO
		 	 , NVL(PP.COUPON_DC_AMT, 0) AS DO_AMT
		 	 , PP.COUPON_OWN_COST AS OWN_COST
		 	 , PP.COUPON_ENTP_COST AS ENTP_COST
		 	 , PROMO.PROMO_BDATE AS COUPON_PROMO_BDATE
		 	 , PROMO.PROMO_EDATE AS COUPON_PROMO_EDATE
		 	 , TO_CHAR(GP.APPLY_DATE, 'YYYYMMDDHH24MISS') AS STOA_APPLY_DATE
		FROM TPAORDERM PM
			,TPATDEALORDERLIST OL
			,TCODE TC
			,TPATDEALGOODS PGM
			,TPAGOODSDTMAPPING PGD
			,TPAGOODSPRICEAPPLY PP 
			,TPROMOM PROMO
			,TGOODSPRICE GP
	   WHERE PM.PA_ORDER_NO			= OL.ORDER_NO
		AND PM.PA_ORDER_SEQ         = OL.OPTION_MANAGEMENT_CD
		AND PM.PA_ORDER_GB          = OL.PA_ORDER_GB
		AND PM.PA_GROUP_CODE        = TC.CODE_MGROUP
		AND PGM.GOODS_CODE      	= PGD.GOODS_CODE
		AND OL.MALL_PRODUCT_NO      = PGM.MALL_PRODUCT_NO
		AND OL.MALL_OPTION_NO       = PGD.PA_OPTION_CODE
		AND PM.PA_CODE          	= PGD.PA_CODE
		AND PGM.PA_GROUP_CODE   	= PM.PA_GROUP_CODE 
		AND PGM.GOODS_CODE    		= PP.GOODS_CODE
		AND PGM.PA_GROUP_CODE 		= PP.PA_GROUP_CODE
		AND PGM.PA_CODE       		= PP.PA_CODE
		AND (PP.APPLY_DATE, PP.PRICE_APPLY_SEQ) = (SELECT /*+ INDEX_DESC (PP2 PK_TPAGOODSPRICEAPPLY)*/
		                                                 PP2.APPLY_DATE, PP2.PRICE_APPLY_SEQ
	                                                 FROM TPAGOODSPRICEAPPLY PP2
	                                                WHERE PP2.GOODS_CODE   = PP.GOODS_CODE
	                                                  AND PP2.PA_GROUP_CODE  = PP.PA_GROUP_CODE
	                                                  AND PP2.PA_CODE    = PP.PA_CODE
	                                                  AND PP2.APPLY_DATE &lt;= OL.ORDER_YMDT 
	                                                  AND PP2.TRANS_DATE &lt;= OL.ORDER_YMDT 
	                                                  AND rownum = 1 )
		
		AND PP.COUPON_PROMO_NO 	    = PROMO.PROMO_NO(+)
		AND GP.GOODS_CODE           = PP.GOODS_CODE
		AND GP.ROWID                = (  SELECT /*+ INDEX_DESC (GP2 PK_TGOODSPRICE)*/
		                                         GP2.ROWID
		                                   FROM TGOODSPRICE GP2
		                                  WHERE GP2.GOODS_CODE = GP.GOODS_CODE
		                                    AND GP2.APPLY_DATE &lt; OL.ORDER_YMDT
		                                    AND ROWNUM = 1)
		AND TC.CODE_LGROUP          = 'O500'
		AND TC.CODE_MGROUP       	=  PM.PA_GROUP_CODE 
		AND PM.PA_ORDER_GB          = '10'
		AND PM.CREATE_YN            = '0'
		AND PM.PRE_CANCEL_YN        = '0'
		AND OL.ADJUSTED_AMT         = (PP.SALE_PRICE - PP.ARS_DC_AMT - PP.COUPON_DC_AMT - PP.LUMP_SUM_DC_AMT) * OL.ORDER_CNT
		AND PM.PA_CODE 				IN ('D1','D2')
		AND PM.PA_ORDER_NO			= #{paOrderNo, jdbcType=VARCHAR}
	
	</select>
	
	<select id="selectSlipProcList" parameterType="hashMap" resultType="hashMap">	 
		SELECT  /* patdealdelivery.xml: patdeal.delivery.selectSlipProcList by PaTdealDeliveryController*/
			   PM.PA_CODE
			 , OL.DELIVERY_NO
			 , DG.PA_DELY_GB 
			 , OL.ORDER_PRODUCT_OPTION_NO
			 , SM.SLIP_NO
			 , PM.MAPPING_SEQ
			 , OL.ORDER_NO
			 , OL.OPTION_MANAGEMENT_CD
	     FROM TPAORDERM PM
			, TPATDEALORDERLIST OL
			, TSLIPM SM
			, TSLIPDT SD
			, TORDERGOODS OG
			, TPADELYGB DG
		 WHERE OL.ORDER_NO                  = PM.PA_ORDER_NO
		   AND OL.OPTION_MANAGEMENT_CD      = PM.PA_ORDER_SEQ
		   AND OL.PA_ORDER_GB               = PM.PA_ORDER_GB
		   AND SM.SLIP_I_NO   				= SD.SLIP_I_NO
		   AND PM.ORDER_NO    				= SD.ORDER_NO
		   AND PM.ORDER_G_SEQ 				= SD.ORDER_G_SEQ
		   AND PM.ORDER_D_SEQ 				= SD.ORDER_D_SEQ
		   AND PM.ORDER_W_SEQ 				= SD.ORDER_W_SEQ
		   AND PM.ORDER_NO    				= OG.ORDER_NO
		   AND PM.ORDER_G_SEQ 				= OG.ORDER_G_SEQ
		   AND PM.PA_DO_FLAG  				= '30'
		   AND PM.PA_ORDER_GB 				= '10'
		   AND SM.SLIP_PROC   				>= '40'
		   AND DG.PA_CODE 					= '13'
		   AND SM.DELY_GB 					= DG.DELY_GB
		   AND (OG.ORDER_QTY - OG.CANCEL_QTY - OG.CLAIM_QTY + OG.CLAIM_CAN_QTY) > 0
		   AND SM.SLIP_NO IS NOT NULL /*운송장이 있는 주문 건*/
		   <if test='paCode != "" and paCode != null '>
               AND PM.PA_CODE = #{paCode , jdbcType=VARCHAR}
           </if>
		   <if test='orderProductOptionNo != "" and orderProductOptionNo != null '>
               AND OL.ORDER_PRODUCT_OPTION_NO = #{orderProductOptionNo , jdbcType=VARCHAR}
           </if>
		   	
			   UNION ALL	  
			   
		SELECT  /*교환발송건*/
		         PM.PA_CODE
		       , OL.SHIPPING_NO AS DELIVERY_NO
		       , DG.PA_DELY_GB 
		       , PM.PA_SHIP_NO AS ORDER_PRODUCT_OPTION_NO
		       , SM.SLIP_NO
		       , PM.MAPPING_SEQ
		       , OL.ORDER_NO
		       , OL.OPTION_MANAGEMENT_CD
	      FROM TPAORDERM PM
		      , TPATDEALCLAIMLIST OL
		      , TSLIPM SM
		      , TSLIPDT SD
		      , TORDERGOODS OG
		      , TPADELYGB DG
		 WHERE OL.ORDER_NO                  = PM.PA_ORDER_NO
	       AND OL.OPTION_MANAGEMENT_CD      = PM.PA_ORDER_SEQ
	       AND OL.PA_ORDER_GB               = PM.PA_ORDER_GB
	       AND SM.SLIP_I_NO           = SD.SLIP_I_NO
	       AND PM.ORDER_NO            = SD.ORDER_NO
	       AND PM.ORDER_G_SEQ         = SD.ORDER_G_SEQ
	       AND PM.ORDER_D_SEQ         = SD.ORDER_D_SEQ
	       AND PM.ORDER_W_SEQ         = SD.ORDER_W_SEQ
	       AND PM.ORDER_NO            = OG.ORDER_NO
	       AND PM.ORDER_G_SEQ         = OG.ORDER_G_SEQ
	       AND PM.PA_SHIP_NO           = OL.ORDER_OPTION_NO
	       AND PM.PA_DO_FLAG          = '30'
	       AND PM.PA_ORDER_GB         = '40'
	       AND SM.SLIP_PROC           >= '40'
	       AND DG.PA_CODE           = '13'
	       AND SM.DELY_GB           = DG.DELY_GB
	       AND PM.PRE_CANCEL_YN     = '0'
	       AND (OG.ORDER_QTY - OG.CANCEL_QTY - OG.CLAIM_QTY + OG.CLAIM_CAN_QTY) > 0
	       AND SM.SLIP_NO IS NOT NULL /*운송장이 있는 주문 건*/
       <if test='paCode != "" and paCode != null '>
               AND PM.PA_CODE = #{paCode , jdbcType=VARCHAR}
       </if>
	   <if test='orderProductOptionNo != "" and orderProductOptionNo != null '>
              AND OL.OPTION_MANAGEMENT_CD = #{orderProductOptionNo , jdbcType=VARCHAR}
       </if>
		   	
	</select>
	
	<select id="selectOrderAbleQty" parameterType="hashMap" resultType="int">
	    SELECT /* patdealgoods.xml : patdeal.delivery.selectOrderAbleQty by PaTdealDeliveryController */
		      DECODE(DT.SALE_GB, '00', NVL(CEIL(FUN_GET_ORDER_ABLE_QTY(PD.GOODS_CODE, PD.GOODSDT_CODE, GD.WH_CODE) * TC.CODE_GROUP), 0), 0) AS ORDER_ABLE_QTY
		 FROM TPAPRODUCTOPTION PD
		    , TPAGOODSDTMAPPING DM
		    , TGOODS GD
		    , TCODE TC
		    , TGOODSDT DT
		WHERE PD.GOODS_CODE = DM.GOODS_CODE
		  AND PD.GOODSDT_CODE = DM.GOODSDT_CODE
		  AND PD.GOODS_CODE = GD.GOODS_CODE
		  AND TC.CODE_LGROUP = 'O505'
		  AND TC.CODE_MGROUP = DM.PA_CODE
		  AND DT.GOODS_CODE = PD.GOODS_CODE
		  AND DT.GOODSDT_CODE = PD.GOODSDT_CODE
		  AND DM.PA_CODE IN ('D1','D2') 
		  AND GD.GOODS_CODE = #{goodsCode, jdbcType=VARCHAR}
		  AND DT.GOODSDT_CODE = #{goodsdtCode, jdbcType=VARCHAR}
	</select>
	
	<select id="selectDeliveryComplete" parameterType="hashMap" resultType="hashMap">	 
		SELECT  /* patdealdelivery.xml: patdeal.delivery.selectDeliveryComplete by PaTdealDeliveryController*/
			   PM.PA_CODE
			 , OL.ORDER_PRODUCT_OPTION_NO
			 , PM.MAPPING_SEQ
	     FROM TPAORDERM PM
			, TPATDEALORDERLIST OL
			, TSLIPM SM
			, TSLIPDT SD
			, TORDERGOODS OG
			, TPADELYGB DG
 		WHERE OL.ORDER_NO                  	    = PM.PA_ORDER_NO
		  AND OL.OPTION_MANAGEMENT_CD      	    = PM.PA_ORDER_SEQ
		  AND OL.PA_ORDER_GB               	    = PM.PA_ORDER_GB
		  AND SM.SLIP_I_NO   					= SD.SLIP_I_NO
		  AND PM.ORDER_NO    					= SD.ORDER_NO
		  AND PM.ORDER_G_SEQ 				    = SD.ORDER_G_SEQ
		  AND PM.ORDER_D_SEQ 				    = SD.ORDER_D_SEQ
		  AND PM.ORDER_W_SEQ 				    = SD.ORDER_W_SEQ
		  AND PM.ORDER_NO    				    = OG.ORDER_NO
		  AND PM.ORDER_G_SEQ 				    = OG.ORDER_G_SEQ
	      AND PM.PA_DO_FLAG          		    = '40'
	      AND PM.PA_ORDER_GB         		    = '10'
	      AND SM.SLIP_PROC           		    = '80'
	      AND DG.PA_CODE             		    = '13'
		  AND SM.DELY_GB 					    = DG.DELY_GB
		  AND TRUNC(SM.SLIP_PROC_DATE)+8    &lt;= SYSDATE
		  AND NOT EXISTS (SELECT 1
                    		 FROM TPATDEALCLAIMLIST PC
                   			WHERE PC.ORDER_OPTION_NOS LIKE '%' || OL.ORDER_PRODUCT_OPTION_NO || '%')
		   <if test='paCode != "" and paCode != null '>
               AND PM.PA_CODE = #{paCode , jdbcType=VARCHAR}
           </if>
		   <if test='orderProductOptionNo != "" and orderProductOptionNo != null '>
               AND OL.ORDER_PRODUCT_OPTION_NO = #{orderProductOptionNo , jdbcType=VARCHAR}
           </if>
		   	  
	</select>
	
	
	<select id="selectTdealAreaGbChk" parameterType="String" resultType="int">
	    SELECT /* patdealgoods.xml : patdeal.delivery.selectTdealAreaGbChk by PaTdealDeliveryController */
			  COUNT(DISTINCT A.AREA_GB)
		 FROM TPOST A
		GROUP BY A.POST_NO
	   HAVING A.POST_NO = #{postNo , jdbcType=VARCHAR}
		  AND COUNT(DISTINCT A.AREA_GB) > 1
	</select>
	
	<select id="selectRefusalInfo" parameterType="String" resultType="hashMap">
       SELECT /* patdealgoods.xml: patdeal.delivery.selectRefusalInfo by PaTdealDeliveryController*/
       	      OL.ORDER_PRODUCT_OPTION_NO
		    , PM.PA_PROC_QTY 
		    , OL.ORDER_NO AS PA_ORDER_NO
		    , '재고부족' AS REASON_DETAIL
		    , PM.PA_CODE
		 FROM TPAORDERM PM 
		    , TPATDEALORDERLIST OL
		WHERE PM.PA_ORDER_NO  = OL.ORDER_NO
		  AND PM.PA_ORDER_SEQ = OL.OPTION_MANAGEMENT_CD
		  AND PM.PA_ORDER_GB  = OL.PA_ORDER_GB
		  AND PM.MAPPING_SEQ  = #{mappingSeq, jdbcType=VARCHAR}
    </select>
</mapper>