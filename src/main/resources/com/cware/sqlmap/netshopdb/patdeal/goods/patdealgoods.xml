<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
        "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="com.cware.netshopping.patdeal.repository.PaTdealGoodsMapper">

	<select id="selectPaTdealGoodsOfferList" parameterType="hashMap" resultType="com.cware.netshopping.domain.PaGoodsOfferVO">
        SELECT /* patdealgoods.xml : patdeal.goods.selectPaTdealGoodsOfferList by PaTdealProductService */
        	   PO.GOODS_CODE
             , PO.PA_GROUP_CODE
             , PO.PA_OFFER_TYPE
             , PO.PA_OFFER_CODE 
             , PO.PA_OFFER_EXT
             , PO.REMARK1
             , PO.REMARK2
             , PC.PA_OFFER_TYPE_NAME
             , PC.PA_OFFER_CODE_NAME
          FROM TPAGOODSOFFER PO
             , TPAOFFERCODE PC
         WHERE PO.PA_GROUP_CODE = PC.PA_GROUP_CODE  
           AND PO.PA_OFFER_TYPE = PC.PA_OFFER_TYPE 
           AND PO.PA_OFFER_CODE = PC.PA_OFFER_CODE  
           AND PO.GOODS_CODE = #{goodsCode, jdbcType=VARCHAR}
           AND PO.PA_GROUP_CODE = #{paGroupCode, jdbcType=VARCHAR}
           AND PO.USE_YN = '1'
    </select>
    
    <select id="selectPaTdealGoodsdtInfoList" parameterType="hashMap" resultType="com.cware.netshopping.domain.model.PaGoodsdtMapping">
        SELECT /* patdealgoods.xml : patdeal.goods.selectPaTdealGoodsdtInfoList by PaTdealProductService */
               PD.GOODS_CODE 
             , DM.PA_CODE
             , PD.GOODSDT_CODE
             , DECODE(PD.GOODSDT_INFO, '없음', '단일상품', PD.GOODSDT_INFO) AS GOODSDT_INFO
             , DECODE(PD.GOODSDT_INFO_KIND, '없음', '단일상품', PD.GOODSDT_INFO_KIND) AS GOODSDT_INFO_KIND
             , DECODE(DT.SALE_GB, '00', NVL(CEIL(FUN_GET_ORDER_ABLE_QTY(PD.GOODS_CODE, PD.GOODSDT_CODE, GD.WH_CODE) * TC.CODE_GROUP), 0), 0) AS TRANS_ORDER_ABLE_QTY
             , PD.SORT_TYPE 
             , DT.COLOR_NAME
             , DT.SIZE_NAME
             , DT.PATTERN_NAME
             , DT.FORM_NAME
             , DM.PA_OPTION_CODE
             , DM.REMARK1
             , DM.TRANS_TARGET_YN
             , DM.TRANS_STOCK_YN
             , DT.SALE_GB
             , TI.IMAGE_PATH
             , TI.IMAGE_FILE
          FROM TPAPRODUCTOPTION PD
             , TPAGOODSDTMAPPING DM
             , TGOODS GD
             , TCODE TC
             , TGOODSDT DT
             , TPATDEALGOODSDTIMAGE TI
         WHERE PD.GOODS_CODE = DM.GOODS_CODE
           AND PD.GOODSDT_CODE = DM.GOODSDT_CODE
           AND PD.GOODS_CODE = GD.GOODS_CODE
           AND TC.CODE_LGROUP = 'O505'
           AND TC.CODE_MGROUP = DM.PA_CODE
           AND DT.GOODS_CODE = PD.GOODS_CODE
           AND DT.GOODSDT_CODE = PD.GOODSDT_CODE
           AND DT.GOODS_CODE = TI.GOODS_CODE(+)
           AND DT.GOODSDT_CODE = TI.GOODSDT_CODE(+)
           AND DM.PA_CODE IN ('D1','D2') 
           AND GD.GOODS_CODE = #{goodsCode, jdbcType=VARCHAR}
         ORDER BY PD.GOODS_CODE
                , PD.GOODSDT_CODE
    </select>
    
    <select id="selectPaTdealGoodsInfo" parameterType="hashMap" resultType="com.cware.netshopping.domain.PaTdealGoodsVO">
        SELECT /* patdealgoods.xml : patdeal.goods.selectPaTdealGoodsInfo by PaTdealProductService */
               TG.GOODS_CODE
			 , T.GOODS_NAME_MC as GOODS_NAME
			 , TG.BRAND_NAME
			 , TG.TAX_YN
			 , TG.ORDER_MAX_QTY
			 , TG.ORDER_MIN_QTY
			 , TG.SHIP_COST_CODE
             , TG.SALE_START_DATE
             , TG.SALE_END_DATE
             , T.ADULT_YN
			 , T.KEYWORD
			 , T.RETURN_NO_YN
			 , T.CUST_ORD_QTY_CHECK_YN
 			 , T.CUST_ORD_QTY_CHECK_TERM
 			 , T.TERM_ORDER_QTY
 			 , T.LMSD_CODE
 			 , NVL((SELECT 1
		              FROM TPACOPNGOODSKINDSFRESH GF
		             WHERE T.LGROUP = GF.LGROUP
		               AND T.MGROUP = GF.MGROUP
		               AND T.SGROUP = GF.SGROUP
		               AND T.DGROUP = GF.DGROUP), 0) AS FRESH_YN
			 , CEIL(FUN_GET_ORDER_ABLE_QTY(PG.GOODS_CODE,'%', T.WH_CODE) * TC2.CODE_GROUP) AS TRANS_ORDER_ABLE_QTY		
			 , NVL((SELECT REPLACE (DS.DESCRIBE_EXT, chr(10), '')
		              FROM TDESCRIBE DS
		             WHERE DS.DESCRIBE_CODE = '998'
		               AND DS.GOODS_CODE = TG.GOODS_CODE)
		          ,(SELECT DECODE(DS.WEB_FLAG, '1',  REPLACE(DS.DESCRIBE_EXT, chr(10), ''), DS.DESCRIBE_NOTE)
		              FROM TDESCRIBE DS
		             WHERE DS.DESCRIBE_CODE = '999'
		               AND DS.GOODS_CODE = TG.GOODS_CODE)) AS DESCRIBE_EXT	
		     , NVL((SELECT DS.DESCRIBE_NOTE
			          FROM TDESCRIBE DS
			         WHERE DS.GOODS_CODE = TG.GOODS_CODE
			           AND DS.DESCRIBE_CODE = '200'), '') AS GOODS_COM
		     , (SELECT CODE_NAME
                  FROM TCODE C1
                 WHERE C1.CODE_LGROUP = 'O507'
                   AND C1.CODE_MGROUP = PG.PA_CODE) AS TOP_IMAGE
             , (SELECT CODE_NAME
                  FROM TCODE C1
                 WHERE C1.CODE_LGROUP = 'O507'
                   AND C1.CODE_MGROUP = DECODE(PG.PA_CODE, 'D1', 'D3', 'D4')) AS BOTTOM_IMAGE                 
             , DECODE(TG.COLLECT_YN,'0','',(SELECT CODE_NAME
                                              FROM TCODE C1
                                             WHERE C1.CODE_LGROUP = 'O507'
                                               AND C1.CODE_MGROUP = '99')) AS COLLECT_IMAGE 
             , NVL((SELECT /*+ INDEX_DESC (TNM IDX_TPANOTICEM_03)*/
             			   TNM.NOTICE_EXT
					  FROM TPANOTICEM TNM
					     , TPANOTICETARGET TNT
					     , TPANOTICEAPPLY TNA
					 WHERE TNM.NOTICE_NO  = TNT.NOTICE_NO
					   AND TNT.GOODS_CODE = TG.GOODS_CODE
					   AND TNM.USE_CODE   = '00'
					   AND INSTR(TNM.PA_GROUP_CODE, PG.PA_GROUP_CODE) > 0
					   AND TNT.NOTICE_NO  = TNA.NOTICE_NO
					   AND TNT.GOODS_CODE = TNA.GOODS_CODE
					   AND TNA.PA_GROUP_CODE = PG.PA_GROUP_CODE
					   AND ROWNUM = 1), '') AS NOTICE_EXT                                         
             , TG.COLLECT_YN                                      
			 , PG.PA_CODE
			 , PG.PA_GROUP_CODE
			 , PG.PA_STATUS
			 , PG.PA_LMSD_KEY
			 , PG.PA_BRAND_NO
			 , PG.MALL_PRODUCT_NO
			 , PP.SALE_PRICE
		     , PP.ARS_DC_AMT
		     , PP.COUPON_DC_AMT
		     , PP.LUMP_SUM_DC_AMT
		     , PP.LUMP_SUM_OWN_DC_AMT
		     , PP.LUMP_SUM_ENTP_DC_AMT
		     , PP.APPLY_DATE
		     , PP.PRICE_APPLY_SEQ
		     , TO_CHAR(T.SALE_START_DATE, 'YYYY') AS SALE_START_DATE
		     , PG.DISP_CAT_ID AS DISPLAY_CATEGORY_ID
		   	 , SC.TEMPLATE_NO AS DELIVERY_TEMPLATE_NO
		     , TI.IMAGE_URL
		     , TI.IMAGE_G AS IMAGE_P
		     , TI.IMAGE_AG AS IMAGE_AP
		     , TI.IMAGE_BG AS IMAGE_BP
		     , TI.IMAGE_CG AS IMAGE_CP
		     , TI.IMAGE_DG AS IMAGE_DP	   
		     , PP.COMMISSION
		     , (SELECT /*+ INDEX_DESC (GIM PK_TGOODSINFOIMAGE)*/ GIM.INFO_IMAGE_FILE 
                      FROM TGOODSINFOIMAGE GIM
                     WHERE GIM.GOODS_CODE = TG.GOODS_CODE 
                       AND GIM.INFO_IMAGE_TYPE = '201'
                       AND ROWNUM = 1 ) AS IMAGE_LIST
		     , (SELECT /*+ INDEX_DESC (GIM PK_TGOODSINFOIMAGE)*/ GIM.INFO_IMAGE_FILE 
                      FROM TGOODSINFOIMAGE GIM
                     WHERE GIM.GOODS_CODE = TG.GOODS_CODE 
                       AND GIM.INFO_IMAGE_TYPE = '40'
                       AND ROWNUM = 1 ) AS IMAGE_MC
             , (SELECT /*+ INDEX_DESC (GIM PK_TGOODSINFOIMAGE)*/ GIM.INFO_IMAGE_FILE 
                      FROM TGOODSINFOIMAGE GIM
                     WHERE GIM.GOODS_CODE = TG.GOODS_CODE 
                       AND GIM.INFO_IMAGE_TYPE = '202'
                       AND ROWNUM = 1 ) AS INFO_IMAGE_G
		  FROM TPAPRODUCT  	 TG
		     , TPATDEALGOODS PG
		     , TGOODS T
             , TCODE           TC2
		     , TPAGOODSPRICEAPPLY PP
		     , TPATDEALSHIPCOST SC 
		     , TGOODSIMAGE TI
		 WHERE TG.GOODS_CODE 	= PG.GOODS_CODE
		   AND PG.GOODS_CODE    = T.GOODS_CODE
		   AND PG.GOODS_CODE 	= PP.GOODS_CODE
		   AND PG.PA_CODE 		= PP.PA_CODE
		   AND T.GOODS_CODE		= TI.GOODS_CODE
		   AND SC.PA_CODE 		= PG.PA_CODE
		   AND SC.ENTP_CODE		= DECODE(T.DELY_TYPE, '10', '100001', T.ENTP_CODE)
		   AND SC.SHIP_MAN_SEQ  = DECODE(T.DELY_TYPE, '10', '003', T.SHIP_MAN_SEQ)
		   AND SC.RETURN_MAN_SEQ = DECODE(T.DELY_TYPE, '10', '002', T.RETURN_MAN_SEQ)
		   AND SC.SHIP_COST_CODE = T.SHIP_COST_CODE 
		   AND SC.TEMPLATE_NO IS NOT NULL
		   AND (PP.APPLY_DATE, PP.PRICE_APPLY_SEQ) = (SELECT /*+ INDEX_DESC (PP2 PK_TPAGOODSPRICEAPPLY)*/
																 PP2.APPLY_DATE, PP2.PRICE_APPLY_SEQ
															FROM TPAGOODSPRICEAPPLY PP2
														   WHERE PP2.GOODS_CODE = PP.GOODS_CODE
															 AND PP2.PA_GROUP_CODE = PP.PA_GROUP_CODE
															 AND PP2.PA_CODE = PP.PA_CODE
															 AND PP2.APPLY_DATE &lt;= SYSDATE
															 AND rownum = 1 )
		<if test='goodsCode != null and goodsCode != ""'>
		   AND TG.GOODS_CODE = #{goodsCode, jdbcType=VARCHAR}
		</if>
		<if test='paCode != null and paCode != ""'>
		   AND PG.PA_CODE = #{paCode, jdbcType=VARCHAR}
		</if>
		<if test='modCase == "MODIFY"'>
		   AND (PG.TRANS_TARGET_YN  = '1' OR PP.TRANS_DATE IS NULL)
		   AND PG.PA_SALE_GB 		= '20'
		   AND PG.PA_STATUS 		= '30'
		   AND PG.MALL_PRODUCT_NO IS NOT NULL
		</if>		
		<if test='modCase == "INSERT"'>
		   AND TG.SALE_GB	= '00'
		</if>
           AND TC2.CODE_LGROUP      = 'O505'
           AND TC2.CODE_MGROUP      = PG.PA_CODE
		   AND ROWNUM &lt; 50000
    </select>   
    
    <select id="selectPaTdealEvent" parameterType="String" resultType="com.cware.netshopping.domain.model.PaTdealEvent">
	    SELECT * 
	      FROM (
		    	SELECT /* patdealgoods.xml : patdeal.goods.selectPaTdealEvent by PaTdealProductService */
		    		   TE.GOODS_CODE
		    	  	 , TE.GOODS_EVENT_NAME
		   		 	 , TE.PROMO_YN
		    		 , TE.DISP_CAT_ID
			    	 , TE.SALE_START_DATE
			  	     , TE.SALE_END_DATE
			  	     , TE.PA_LMSD_KEY
			  	     , TE.PA_BRAND_NO
			  	     , TE.CART_USE_YN
			  	     , TE.MAX_BUY_PERSON_CNT
				  FROM TPATDEALEVENT TE
				 WHERE TE.GOODS_CODE = #{goodsCode, jdbcType=VARCHAR}
				   AND SYSDATE BETWEEN TE.EVENT_BDATE AND TE.EVENT_EDATE
				   AND TE.USE_YN = '1'
				   ORDER BY TE.MODIFY_DATE )
		  WHERE ROWNUM = 1
    </select>   
    
</mapper>